server:
  port: 88

# 本地开发默认使用 dev profile（关闭 Consul，静态 URI 转发）；生产环境通过 SPRING_PROFILES_ACTIVE 覆盖
spring:
  profiles:
    active: dev
  main:
    web-application-type: reactive
  application:
    name: gulimall-gateway
  # 从 AWS 导入配置（可选：本地无 AWS 时仍可启动）
  config:
    import:
      # 敏感配置（如 API 密钥、签名密钥）→ Secrets Manager
      - optional:aws-secretsmanager:gulimall/gateway/config
      # 非敏感配置 → Parameter Store，加载 /gulimall/gateway/ 下的参数
      - optional:aws-parameterstore:/gulimall/gateway/
  cloud:
    # AWS 区域（Secrets Manager / Parameter Store 用；也可用环境变量 AWS_REGION）
    aws:
      region:
        static: us-west-2
    consul:
      host: localhost
      port: 8500
      discovery:
        enabled: true
        hostname: host.docker.internal
        prefer-ip-address: true
    gateway:
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials, RETAIN_UNIQUE
      routes:
        # 优惠券服务路由
        - id: gulimall-coupon-route
          uri: lb://gulimall-coupon
          predicates:
            - Path=/api/coupon/**
          filters:
            - RewritePath=/api/(?<segment>.*), /$\{segment}
        
        # 会员服务路由
        - id: gulimall-member-route
          uri: lb://gulimall-member
          predicates:
            - Path=/api/member/**
          filters:
            - RewritePath=/api/(?<segment>.*), /$\{segment}
        
        # 订单服务路由
        - id: gulimall-order-route
          uri: lb://gulimall-order
          predicates:
            - Path=/api/order/**
          filters:
            - RewritePath=/api/(?<segment>.*), /$\{segment}
        
        # 商品服务路由
#        - id: gulimall-product-route
#          uri: lb://gulimall-product
#          predicates:
#            - Path=/api/product/**
#          filters:
#            - RewritePath=/api/product/(?<segment>.*), /$\{segment}
        
        # 仓储服务路由
        - id: gulimall-ware-route
          uri: lb://gulimall-ware
          predicates:
            - Path=/api/ware/**
          filters:
            - RewritePath=/api/(?<segment>.*), /$\{segment}
        
#        # 测试路由 - 百度
#        - id: test_route
#          uri: https://www.baidu.com
#          predicates:
#            - Query=url, baidu
#
#        # 测试路由 - QQ
#        - id: qq_route
#          uri: https://www.qq.com
#          predicates:
#            - Query=url, qq

        # 验证码路由：用 lb://renren-fast 走 Consul，不依赖 RENREN_FAST_URI（否则未设时走 localhost:8080 必超时）
        - id: captcha-api-route
          uri: lb://renren-fast
          order: -1
          predicates:
            - Path=/api/captcha.jpg
          filters:
            - RewritePath=/api/(?<segment>.*), /api/$\{segment}

        # 兼容旧路径 /captcha.jpg（无 /api 前缀）
        - id: captcha-route
          uri: lb://renren-fast
          order: -1
          predicates:
            - Path=/captcha.jpg
          filters:
            - RewritePath=/captcha.jpg, /api/captcha.jpg

        # Product service route
        - id: product_route
          uri: lb://gulimall-product
          predicates:
            - Path=/api/product/**
          filters:
            - RewritePath=/api/(?<segment>.*), /$\{segment}

        # Third-party service route
        - id: third_party_route
          uri: lb://gulimall-third-party
          predicates:
            - Path=/api/third-party/**
          filters:
            - RewritePath=/api/(?<segment>.*), /$\{segment}

        # ... 其他路由 ...
        - id: admin_route
          uri: lb://renren-fast
          predicates:
            - Path=/api/**
          filters:
            # renren-fast context-path is /api, so keep /api/xxx as path
            - RewritePath=/api/(?<segment>.*), /api/$\{segment}



